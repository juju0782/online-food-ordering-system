<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Profit & Product Update</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">


    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        .btn-custom {
            background-color: #28a745;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2 class="mb-4">Admin Dashboard - Profit Calculation</h2>

        <form id="profit-form" class="mb-4" onsubmit="event.preventDefault(); fetchProfit();">
            <label for="start_date" class="form-label">Start Date:</label>
            <input type="date" id="start_date" name="start_date" class="form-control mb-2" required>

            <label for="end_date" class="form-label">End Date:</label>
            <input type="date" id="end_date" name="end_date" class="form-control mb-3" required>

            <button type="submit" class="btn btn-custom w-100">Calculate Profit</button>
        </form>

        <h3 class="text-center">Total Profit: <span id="profit-amount" class="text-success">KES 0</span></h3>
        <p id="date-range" class="text-center text-muted"></p>


        <div class="text-center my-3" id="loading-spinner" style="display:none;">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <div id="daily-profit-breakdown" class="mt-5" style="display: none;">
            <h4>Daily Profit Breakdown</h4>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Profit (KES)</th>
                    </tr>
                </thead>
                <tbody id="profit-table-body">
    
                </tbody>
            </table>
        </div>

        <hr class="my-5">

        <h2 class="mb-4">Update Product Details</h2>

        <form id="updateProductForm">
            <input type="number" id="product_id" placeholder="Product ID" class="form-control mb-2" required>
            <input type="number" id="new_price" placeholder="New Price" step="0.01" class="form-control mb-2" required>
            <input type="number" id="new_quantity" placeholder="New Quantity" class="form-control mb-3" required>

            <button type="submit" class="btn btn-primary w-100">Update Product</button>
        </form>
    </div>


    <script>
        function fetchProfit() {
    const startDate = document.getElementById("start_date").value;
    const endDate = document.getElementById("end_date").value;

    if (!startDate || !endDate) {
        Swal.fire('Error', 'Please select both start and end dates.', 'error');
        return;
    }

    fetch("/admin/calculate-profit", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ start_date: startDate, end_date: endDate })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to calculate profit');
        }
        return response.json();
    })
    .then(data => {
        console.log("Profit response:", data);

        document.getElementById("profit-amount").textContent = `KES ${data.total_profit}`;
        document.getElementById("date-range").textContent = `${startDate} to ${endDate}`;

        const tbody = document.getElementById("profit-table-body");
        tbody.innerHTML = "";

        if (data.profits && data.profits.length > 0) {
            document.getElementById("daily-profit-breakdown").style.display = "block";

            data.profits.forEach(day => {
                const row = `<tr><td>${day.date}</td><td>KES ${day.profit}</td></tr>`;
                tbody.innerHTML += row;
            });
        } else {
            document.getElementById("daily-profit-breakdown").style.display = "none";
        }
    })
    .catch(error => {
        console.error("Error:", error);
        Swal.fire('Error', 'Failed to calculate profit', 'error');
    });
}

        document.getElementById("updateProductForm").onsubmit = async function(event) {
            event.preventDefault();

            const productId = document.getElementById("product_id").value;
            const newPrice = document.getElementById("new_price").value;
            const newQuantity = document.getElementById("new_quantity").value;

            try {
                const response = await fetch("/update-product", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ product_id: productId, price: newPrice, quantity: newQuantity })
                });

                const result = await response.json();

                if (result.success) {
                    Swal.fire('Success', result.message, 'success');
                    // Clear form after successful update
                    document.getElementById("updateProductForm").reset();
                } else {
                    Swal.fire('Error', result.message, 'error');
                }
            } catch (error) {
                console.error("Error:", error);
                Swal.fire('Error', 'Failed to update product', 'error');
            }
        };
    </script>
</body>
</html>
